#!/usr/bin/env bash
set -euo pipefail

# see https://stackoverflow.com/a/53574193/465684

docker history --no-trunc --format "{{.CreatedBy}}" $1 | # extract information from layers
    tac                                                | # reverse the file
    sed 's,^\(|3.*\)\?/bin/\(ba\)\?sh -c,RUN,'         | # change /bin/(ba)?sh calls to RUN
    sed 's,^RUN #(nop) *,,'                            | # remove RUN #(nop) calls for ENV,LABEL...
    sed 's,  *&&  *, \\\n \&\& ,g'                       # pretty print multi command lines following Docker best practices
