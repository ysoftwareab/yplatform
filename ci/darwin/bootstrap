#!/usr/bin/env bash
set -euo pipefail

SUPPORT_FIRECLOUD_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
source ${SUPPORT_FIRECLOUD_DIR}/sh/common.inc.sh

[[ "${CI:-}" != "true" ]] || {
    # improve date-time (ntp) sync
    (
        ${SUDO} touch /var/db/ntp-kod
        ${SUDO} chown root:wheel /var/db/ntp-kod
        ${SUDO} sntp -sS time.apple.com
    ) || true
}

if [[ "${SF_SKIP_COMMON_BOOTSTRAP:-}" = "true" ]]; then
    echo_info "SF_SKIP_COMMON_BOOTSTRAP=${SF_SKIP_COMMON_BOOTSTRAP}"
    echo_skip "ci/brew-bootstrap.inc.sh"
else
    source ${SUPPORT_FIRECLOUD_DIR}/ci/brew-bootstrap.inc.sh
fi

source ${SUPPORT_FIRECLOUD_DIR}/ci/brew-util.inc.sh
brew_update
brew_brewfile_inc_sh
brew_list

[[ "${SF_PRINTENV_BOOTSTRAP:-}" != "true" ]] || {
    echo_do "Printenv..."
    printenv
    echo_done
}

# see https://github.com/Homebrew/brew/issues/5013
hash -r
